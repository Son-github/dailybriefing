name: Deploy auth-service to ECS

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/auth-service/**"
      - ".github/workflows/deploy-auth-service.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: auth-service-deploy
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-2
  CLUSTER_NAME: dailybriefing-cluster

  ECS_SERVICE_NAME: dailybriefing-auth-service
  IMAGE_NAME: auth-service

  ECR_REPO_PREFIX: 953013523670.dkr.ecr.ap-northeast-2.amazonaws.com/dailybriefing

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Build auth-service (Gradle)
        working-directory: backend/auth-service
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Debug - AWS identity
        run: |
          aws sts get-caller-identity

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker image (latest + sha)
        working-directory: backend/auth-service
        env:
          IMAGE_URI: ${{ env.ECR_REPO_PREFIX }}/${{ env.IMAGE_NAME }}
          GIT_SHA: ${{ github.sha }}
        run: |
          echo "IMAGE_URI=${IMAGE_URI}"
          docker build -t ${IMAGE_URI}:latest -t ${IMAGE_URI}:${GIT_SHA} .
          docker push ${IMAGE_URI}:latest
          docker push ${IMAGE_URI}:${GIT_SHA}

      - name: Force new deployment on ECS service
        env:
          ECS_CLUSTER: ${{ env.CLUSTER_NAME }}
          ECS_SERVICE: ${{ env.ECS_SERVICE_NAME }}
        run: |
          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --force-new-deployment

      # ✅ (핵심) 현재 ECS 서비스에 연결된 Target Group ARN을 자동으로 가져오기
      - name: Resolve Target Group ARN from ECS service
        id: resolve_tg
        env:
          ECS_CLUSTER: ${{ env.CLUSTER_NAME }}
          ECS_SERVICE: ${{ env.ECS_SERVICE_NAME }}
        run: |
          TG_ARN=$(aws ecs describe-services \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}" \
            --query "services[0].loadBalancers[0].targetGroupArn" \
            --output text)

          echo "Resolved TG_ARN=${TG_ARN}"

          if [ -z "${TG_ARN}" ] || [ "${TG_ARN}" = "None" ]; then
            echo "ERROR: TG_ARN not found from ECS service."
            exit 1
          fi

          echo "TG_ARN=${TG_ARN}" >> $GITHUB_OUTPUT

      - name: Wait for service stability (with timeout)
        env:
          ECS_CLUSTER: ${{ env.CLUSTER_NAME }}
          ECS_SERVICE: ${{ env.ECS_SERVICE_NAME }}
        run: |
          # 5분 안에 안정화가 안 되면 실패 처리
          timeout 300 aws ecs wait services-stable \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}"

      # ✅ 성공 시에도 Target Group health를 한번 출력
      - name: Show Target Group health (after success)
        if: success()
        run: |
          echo "==== Target Group Health (success) ===="
          aws elbv2 describe-target-health \
            --target-group-arn "${{ steps.resolve_tg.outputs.TG_ARN }}" \
            --output json

      # ❌ 실패 시: ECS 서비스 이벤트(가장 중요)
      - name: Debug - ECS service events (on failure)
        if: failure()
        env:
          ECS_CLUSTER: ${{ env.CLUSTER_NAME }}
          ECS_SERVICE: ${{ env.ECS_SERVICE_NAME }}
        run: |
          echo "==== ECS Service Describe (events) ===="
          aws ecs describe-services \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}" \
            --query "services[0].{status:status,desired:desiredCount,running:runningCount,pending:pendingCount,events:events[0:15]}" \
            --output json

      # ❌ 실패 시: Target Group health(헬스체크 실패 이유가 여기에 보임)
      - name: Debug - Target Group health (on failure)
        if: failure()
        run: |
          echo "==== Target Group Health (failure) ===="
          aws elbv2 describe-target-health \
            --target-group-arn "${{ steps.resolve_tg.outputs.TG_ARN }}" \
            --output json

      # ❌ 실패 시: STOPPED 태스크의 종료 사유/exitCode
      - name: Debug - Recent stopped tasks (on failure)
        if: failure()
        env:
          ECS_CLUSTER: ${{ env.CLUSTER_NAME }}
          ECS_SERVICE: ${{ env.ECS_SERVICE_NAME }}
        run: |
          echo "==== Recent STOPPED Tasks ===="
          TASK_ARNS=$(aws ecs list-tasks \
            --cluster "${ECS_CLUSTER}" \
            --service-name "${ECS_SERVICE}" \
            --desired-status STOPPED \
            --max-results 5 \
            --query "taskArns[]" \
            --output text)

          if [ -z "${TASK_ARNS}" ]; then
            echo "No stopped tasks found."
            exit 0
          fi

          aws ecs describe-tasks \
            --cluster "${ECS_CLUSTER}" \
            --tasks ${TASK_ARNS} \
            --query "tasks[].{taskArn:taskArn,stoppedReason:stoppedReason,stopCode:stopCode,containers:containers[].{name:name,exitCode:exitCode,reason:reason,lastStatus:lastStatus}}" \
            --output json
