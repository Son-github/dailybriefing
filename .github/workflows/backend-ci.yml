name: Deploy auth-service to ECS

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/auth-service/**"
      - ".github/workflows/deploy-auth-service.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: auth-service-deploy
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-2
  CLUSTER_NAME: dailybriefing-cluster

  ECS_SERVICE_NAME: dailybriefing-auth-service
  IMAGE_NAME: auth-service

  ECR_REPO_PREFIX: 953013523670.dkr.ecr.ap-northeast-2.amazonaws.com/dailybriefing

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Build auth-service (Gradle)
        working-directory: backend/auth-service
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker image (latest + sha)
        working-directory: backend/auth-service
        env:
          IMAGE_URI: ${{ env.ECR_REPO_PREFIX }}/${{ env.IMAGE_NAME }}
          GIT_SHA: ${{ github.sha }}
        run: |
          echo "IMAGE_URI=${IMAGE_URI}"
          docker build -t ${IMAGE_URI}:latest -t ${IMAGE_URI}:${GIT_SHA} .
          docker push ${IMAGE_URI}:latest
          docker push ${IMAGE_URI}:${GIT_SHA}

      - name: Force new deployment on ECS service
        env:
          ECS_CLUSTER: ${{ env.CLUSTER_NAME }}
          ECS_SERVICE: ${{ env.ECS_SERVICE_NAME }}
        run: |
          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --force-new-deployment

      - name: Wait for service stability
        env:
          ECS_CLUSTER: ${{ env.CLUSTER_NAME }}
          ECS_SERVICE: ${{ env.ECS_SERVICE_NAME }}
        run: |
          aws ecs wait services-stable \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}"
